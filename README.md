# 小青 Discord 機器人

一個具有 AI 對話、塔羅牌占卜、食物推薦、怪物系統、故事生成和繪圖功能的 Discord 機器人。

## 功能特色

- 🤖 **AI 對話**：基於 GPT-5.1 的智能陪伴機器人，專長 CBT 認知行為療法
- 🔮 **塔羅牌占卜**：提供 78 張塔羅牌解讀服務
- 🍽️ **食物推薦**：根據台灣時間自動判斷餐點並推薦美食
- 🎮 **怪物系統**：生成並攻擊怪物的遊戲系統，支援個人和團隊目標
- 📖 **故事生成**：根據指定字數和類型生成原創故事
- 🎨 **AI 繪圖**：使用 DALL-E 3 生成圖片
- 💾 **對話記錄**：自動儲存用戶對話歷史（最多 60 條）

## 安裝步驟

### 1. 安裝 Python 套件

```bash
pip install -r requirements.txt
```

### 2. 設定環境變數

建立 `.env` 檔案並填入以下資訊：

```
DISCORD_TOKEN=你的Discord機器人Token
OPENAI_API_KEY=你的OpenAI API金鑰
```

**注意**：目前專案中沒有 `.env` 檔案，你需要自行創建。

### 3. Discord 開發者門戶設定

1. 前往 [Discord 開發者門戶](https://discord.com/developers/applications/)
2. 選擇你的應用程式
3. 在 **Bot** 設定中啟用以下權限：
   - **MESSAGE CONTENT INTENT**（必須啟用，用於讀取訊息內容）
   - **SERVER MEMBERS INTENT**（可選，用於準確獲取身分組成員數量）

## 使用方式

### 基本指令格式

- **AI 對話**：使用 `@小青` 提及機器人即可開始對話
- **其他功能**：使用 `小青!` 前綴，例如：`小青!吃什麼`

### AI 對話功能

- `@小青 你好` - 開始一般對話
- 支援中文對話，會自動記錄對話歷史（最多 60 條）
- 機器人會以親切、真誠的方式回應，每次回覆控制在 50 字以內
- 專長領域：CBT 認知行為療法，提供同理心且不帶評判的回應

### 食物推薦功能

- `小青!吃什麼` - 根據台灣時間自動判斷餐點並推薦美食
- 根據台灣時間自動判斷：
  - **早餐**：05:00 - 10:59
  - **午餐**：11:00 - 13:59
  - **晚餐**：17:00 - 20:59
  - **點心**：其他時段
- 透過線上查詢台灣常見餐點，不是寫死在程式裡的隨機菜單

### 塔羅牌占卜功能

- 自動偵測包含「塔羅」、「抽牌」、「占卜」、「運勢」、「預測」等關鍵字的訊息
- 包含完整的 78 張塔羅牌（大阿爾卡納 22 張 + 小阿爾卡納 56 張）
- 支援針對性問題解讀，格式：`小青!塔羅牌，你的問題`
- 根據問題提供專業解讀（100-150 字）
- 範例：
  - `小青!塔羅牌，我的愛情運勢如何？`
  - `小青!塔羅牌，今天的工作會順利嗎？`
  - `小青!塔羅牌，我的財運怎麼樣？`

### 怪物系統功能

#### 生成怪物
- `小青!生成怪物` - 生成三隻怪物（低階、中階、高階各一隻）
- 怪物血量計算公式：
  - 基礎血量 = 玩家人數 × 3 × 2 × 上個月個人總擊殺數（若為 0 則以 1 計算）
  - 低階怪物：基礎血量 × 1
  - 中階怪物：基礎血量 × 2
  - 高階怪物：基礎血量 × 3
- 團隊目標：玩家人數 × 2（每月第一次生成時設定）
- 每月自動清空上個月的未擊殺怪物

#### 攻擊怪物
- `小青!怪物名稱 傷害值` - 攻擊指定怪物
- 範例：`小青!暗影獸 50`
- 擊敗怪物後會：
  - 增加個人擊殺數
  - 增加團隊擊殺數
  - 顯示擊殺統計資訊

### 故事生成功能

- 格式：`小青!X字故事` 或 `小青!X字XX故事`
- 支援的故事類型：愛情、冒險、懸疑、科幻、奇幻、歷史、現代、童話
- 字數限制：最多 10000 字
- 範例：
  - `小青!1000字故事` - 生成 1000 字的現代故事
  - `小青!500字愛情故事` - 生成 500 字的愛情故事
  - `小青!2000字冒險故事` - 生成 2000 字的冒險故事

### 繪圖功能

- `小青!draw <描述>` - 使用 DALL-E 3 生成 AI 圖片
- 範例：`小青!draw 一隻可愛的貓咪在花園裡`
- 生成高品質 1024x1024 圖片

## 資料庫功能

機器人使用 SQLite 資料庫（`chat_history.db`）儲存以下資料：

- **對話記錄**：用戶與機器人的對話歷史（每個用戶最多 60 條）
- **怪物資料**：伺服器中的怪物資訊
- **攻擊記錄**：玩家攻擊怪物的記錄
- **團隊目標**：每月的團隊擊殺目標
- **個人擊殺統計**：每個玩家的擊殺數量統計

## 注意事項

### 系統需求
- Python 3.8 或更高版本
- Discord.py 2.0 或更高版本
- 穩定的網路連接
- 足夠的磁碟空間（用於資料庫和臨時圖片檔案）

### 權限設定
- **MESSAGE CONTENT INTENT**：必須在 Discord 開發者門戶啟用，否則機器人無法讀取訊息內容
- **SERVER MEMBERS INTENT**：可選，但建議啟用以準確獲取身分組成員數量。如果未啟用，怪物系統會使用預設值 1 進行計算

### 功能限制
- 對話記錄：每個用戶最多儲存 60 條記錄，超過會自動刪除最舊的記錄
- 故事字數：最多 10000 字
- 怪物系統：需要指定身分組 ID

### 資料庫維護
- 資料庫會自動檢查完整性並嘗試修復
- 每月自動清空上個月的未擊殺怪物
- 如果資料庫損壞，會自動創建備份並重新建立

## 故障排除

### 常見錯誤

1. **特權意圖錯誤**
   - 錯誤訊息：`requesting privileged intents that have not been explicitly enabled`
   - 解決方法：前往 Discord 開發者門戶啟用 **MESSAGE CONTENT INTENT**

2. **無法獲取身分組成員數量**
   - 警告訊息：`無法獲取身分組成員數量（需要啟用 SERVER MEMBERS INTENT）`
   - 解決方法：在 Discord 開發者門戶啟用 **SERVER MEMBERS INTENT**，或在代碼中取消註釋 `intents.members = True`

3. **資料庫錯誤**
   - 機器人會自動嘗試修復損壞的資料庫
   - 如果修復失敗，會創建備份並重新建立資料庫

4. **環境變數缺失**
   - 錯誤訊息：`缺少 DISCORD_TOKEN 環境變數` 或 `缺少 OPENAI_API_KEY 環境變數`
   - 解決方法：確認 `.env` 檔案存在且包含必要的環境變數

## 授權

本專案採用 MIT 授權條款。

